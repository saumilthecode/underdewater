<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Underwater Exploration</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #depth-meter {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div id="depth-meter">Depth: <span id="depth-value">0</span> meters</div>
  
  <!-- A-Frame Scene -->
  <a-scene environment="preset: underwater; fog: 0.02; dressingAmount: 30; grid: none; shadow: true">

    <!-- Camera and Controls -->
    <a-entity id="camera" camera look-controls wasd-controls="fly: true" position="0 2 0"></a-entity>

    <!-- Dynamic Lighting Effects -->
    <a-light type="directional" color="#fff" intensity="1" position="0 10 -10" castShadow>
      <a-animation attribute="intensity" from="0.5" to="1.5" dur="5000" direction="alternate" repeat="indefinite"></a-animation>
    </a-light>
    <a-light type="ambient" color="#a3d5ff"></a-light>

    <!-- Brighter Ocean Background -->
    <a-sky color="#0096c7"></a-sky>

    <!-- Enhanced Marine Life -->
    <!-- Clownfish with Smooth Swimming and Fins Animation -->
    <a-entity id="clownfish" position="1 1 -3">
      <a-sphere radius="0.2" color="orange" position="0 0 0" shadow></a-sphere>
      <a-sphere radius="0.15" color="white" position="0.1 0.1 0" shadow></a-sphere>
      <a-sphere radius="0.15" color="white" position="-0.1 0.1 0" shadow></a-sphere>
      <a-cone radius-bottom="0.1" height="0.2" color="white" position="0 -0.1 0" rotation="90 0 0"></a-cone>
      <a-cone radius-bottom="0.05" height="0.15" color="black" position="0 -0.2 0" rotation="90 0 0"></a-cone>
      <a-cone radius-bottom="0.1" height="0.2" color="white" position="0 0.1 0" rotation="90 0 0"></a-cone>
      <!-- Animated fins with smooth oscillation -->
      <a-plane width="0.05" height="0.2" color="orange" position="-0.2 0 0" rotation="0 0 15"
               animation="property: rotation; to: 0 0 30; dir: alternate; dur: 1000; easing: easeInOutSine; loop: true"></a-plane>
      <a-plane width="0.05" height="0.2" color="orange" position="0.2 0 0" rotation="0 0 -15"
               animation="property: rotation; to: 0 0 -30; dir: alternate; dur: 1000; easing: easeInOutSine; loop: true"></a-plane>
      <!-- Swimming animation with smoother transitions -->
      <a-animation attribute="position" to="2 1 -3" direction="alternate" dur="5000" easing="easeInOutSine" repeat="indefinite"></a-animation>
    </a-entity>

    <!-- Jellyfish with Enhanced Tentacle Animation -->
    <a-entity id="jellyfish" position="2 3 -6">
      <a-sphere radius="0.3" color="pink" position="0 0 0" shadow></a-sphere>
      <!-- Tentacles with improved movement -->
      <a-cylinder radius="0.02" height="0.6" color="pink" position="-0.1 -0.6 0" 
                  animation="property: position; to: -0.1 -0.8 0; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true"></a-cylinder>
      <a-cylinder radius="0.02" height="0.6" color="pink" position="0.1 -0.6 0.1" 
                  animation="property: position; to: 0.1 -0.8 0.1; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true"></a-cylinder>
      <a-cylinder radius="0.02" height="0.6" color="pink" position="0.1 -0.6 -0.1" 
                  animation="property: position; to: 0.1 -0.8 -0.1; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true"></a-cylinder>
      <a-cylinder radius="0.02" height="0.6" color="pink" position="-0.1 -0.6 -0.1" 
                  animation="property: position; to: -0.1 -0.8 -0.1; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true"></a-cylinder>
      <a-cylinder radius="0.02" height="0.6" color="pink" position="-0.2 -0.6 0" 
                  animation="property: position; to: -0.2 -0.8 0; dir: alternate; dur: 2000; easing: easeInOutSine; loop: true"></a-cylinder>
    </a-entity>

    <!-- Enhanced Seaweed with Swirling Motion -->
    <a-entity geometry="primitive: cylinder; radius: 0.2; height: 1" material="color: green; roughness: 0.8" position="-1 0.5 -4"
              animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true"></a-entity>
    <a-entity geometry="primitive: cone; radius-bottom: 0.5; height: 1.5" material="color: darkgreen" position="3 0.75 -6"
              animation="property: rotation; to: 0 360 0; dur: 12000; easing: linear; loop: true"></a-entity>

    <!-- Improved Interactive Rocks and Treasures -->
    <a-entity id="rock1" geometry="primitive: box; width: 1; height: 1; depth: 1"
              material="color: #7f8c8d; roughness: 1; metalness: 0.5"
              position="0 0.5 -5"
              shadow cast
              class="clickable"
              dissolve-on-look>
    </a-entity>
    <a-entity id="treasure1" geometry="primitive: box; width: 0.5; height: 0.5; depth: 0.5"
              material="color: #f39c12; roughness: 0.5; metalness: 1"
              position="4 0.5 -10"
              class="clickable"
              dissolve-on-look>
    </a-entity>

    <!-- Detailed Particle Effects for Floating Particles -->
    <a-entity particle-system="preset: dust; color: #ffffff; particleCount: 1000; size: 0.2; velocityValue: 0 0.05 0; opacity: 0.5;"></a-entity>

    <!-- Sound for Underwater Environment -->
    <a-sound src="url(underwater-sound.mp3)" autoplay="true" loop="true" volume="0.5"></a-sound>

    <!-- Event Listener Script -->
    <script>
      // Register custom component to handle dissolve on look
      AFRAME.registerComponent('dissolve-on-look', {
        schema: {
          lookDuration: { type: 'number', default: 1000 }
        },

        init: function () {
          this.camera = document.querySelector('#camera');
          this.dissolving = false;
        },

        tick: function () {
          if (this.camera) {
            const cameraEl = this.camera.object3D;
            const objectEl = this.el.object3D;
            const cameraPos = cameraEl.position;
            const objectPos = objectEl.position;
            const direction = new THREE.Vector3();
            cameraEl.getWorldDirection(direction);
            const objectDirection = new THREE.Vector3().subVectors(objectPos, cameraPos).normalize();

            // Check if the object is in the camera's view
            const dotProduct = direction.dot(objectDirection);

            if (dotProduct > 0.9 && !this.dissolving) { // Adjust this threshold for sensitivity
              this.dissolving = true;
              this.el.setAttribute('animation__dissolve', {
                property: 'scale',
                to: '0 0 0',
                dur: this.data.lookDuration,
                easing: 'easeInOutQuad'
              });
            }
          }
        }
      });

      // Assign the dissolve behavior to rocks and treasures
      document.querySelector('#rock1').setAttribute('dissolve-on-look', { lookDuration: 1000 });
      document.querySelector('#treasure1').setAttribute('dissolve-on-look', { lookDuration: 1000 });
    </script>
  </a-scene>
</body>
</html>
